{% extends "lora_admin/base.html" %}
{% load lora_admin_extras %}

{% block content %}
<div class="page-header">
  <h1>Booking #{{ booking.id }}</h1>
  <a href="{% url 'lora_admin:bookings' %}" class="btn btn-outline">‚Üê Back to Bookings</a>
</div>

<div class="booking-detail-card">
  <!-- Prominent Customer Phone Section -->
  <div class="booking-detail-section booking-phone-section">
    <h3>Customer Contact Number</h3>
    <div class="booking-phone-block">
      {% if booking.phone %}
      <span class="booking-phone-number">{{ booking.phone }}</span>
      <div class="contact-actions-block">
        <a href="tel:{{ booking.phone }}" class="btn btn-contact btn-lg-contact" title="Call customer">üìû Call</a>
        <a href="https://wa.me/{{ booking.phone|phone_digits }}" class="btn btn-whatsapp btn-lg-contact" target="_blank" rel="noopener" title="WhatsApp customer">WhatsApp</a>
      </div>
      {% else %}
      <span class="booking-no-phone">No phone provided</span>
      <a href="mailto:{{ booking.email }}" class="btn btn-contact btn-lg-contact">‚úâÔ∏è Email</a>
      {% endif %}
    </div>
  </div>

  <div class="booking-detail-section">
    <h3>Guest Details</h3>
    <dl class="detail-list">
      <dt>Name</dt>
      <dd>{{ booking.full_name }}</dd>
      <dt>Email</dt>
      <dd><a href="mailto:{{ booking.email }}">{{ booking.email }}</a></dd>
    </dl>
  </div>

  <div class="booking-detail-section">
    <h3>Visit Request</h3>
    <dl class="detail-list">
      <dt>Property</dt>
      <dd><a href="{% url 'lora_admin:property_detail' booking.property_id %}">{{ booking.property.title }}</a></dd>
      <dt>Preferred Date</dt>
      <dd>{{ booking.preferred_date }}</dd>
      <dt>Preferred Time</dt>
      <dd>{{ booking.preferred_time }}</dd>
      {% if booking.message %}
      <dt>Message</dt>
      <dd class="booking-message">{{ booking.message }}</dd>
      {% endif %}
    </dl>
  </div>

  <div class="booking-detail-section">
    <h3>Status</h3>
    <form method="post" class="booking-status-form" id="bookingStatusForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_status">
      <div class="form-row form-row-inline">
        <select name="status" class="form-input form-select" id="bookingStatusSelect">
          {% for val, label in booking.Status.choices %}
          <option value="{{ val }}" {% if booking.status == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary" id="bookingStatusBtn">Update Status</button>
      </div>
    </form>
    {% if booking.status != "completed" and booking.status != "cancelled" %}
    <p class="booking-reminder"><small>üí° Remember to contact the customer and confirm the visit before marking as Completed.</small></p>
    {% endif %}
  </div>
</div>

<p class="booking-meta"><small>Submitted {{ booking.created_at|date:"F d, Y \a\t H:i" }}</small></p>

{% endblock %}

{% block extrajs %}
<script>
(function() {
  var form = document.getElementById('bookingStatusForm');
  var select = document.getElementById('bookingStatusSelect');
  if (!form || !select) return;

  form.addEventListener('submit', function(e) {
    var newStatus = select.value;
    if (newStatus === 'completed') {
      if (!confirm('Have you contacted this customer and confirmed the visit? Marking as Completed.')) {
        e.preventDefault();
      }
    }
  });
})();
</script>
{% endblock %}
