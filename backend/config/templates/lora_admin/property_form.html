{% extends "lora_admin/base.html" %}

{% block content %}
<div class="page-header">
  <h1>{% if property %}Edit Property{% else %}Add Property{% endif %}</h1>
  {% if property %}
  <a href="{% url 'lora_admin:property_detail' property.pk %}" class="btn btn-outline">Cancel</a>
  {% else %}
  <a href="{% url 'lora_admin:dashboard' %}" class="btn btn-outline">Cancel</a>
  {% endif %}
</div>

<form method="post" enctype="multipart/form-data" class="property-form">
  {% csrf_token %}
  {% if form.non_field_errors %}
  <div class="form-errors" role="alert">{{ form.non_field_errors }}</div>
  {% endif %}
  {% if form.errors and not form.non_field_errors %}
  <div class="form-errors" role="alert">
    <strong>Please correct the errors below:</strong>
    {% for field in form %}{% if field.errors %}<p>{{ field.label }}: {{ field.errors|striptags }}</p>{% endif %}{% endfor %}
  </div>
  {% endif %}

  <section class="form-section">
    <h3>1. Category</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="id_listing_type">Listing Type</label>
        {{ form.listing_type }}
      </div>
      <div class="form-group">
        <label for="id_property_type">Property Type</label>
        {{ form.property_type }}
      </div>
    </div>
  </section>

  <section class="form-section">
    <h3>2. Basic Info</h3>
    <div class="form-group">
      <label for="id_title">Title</label>
      {{ form.title }}
      {{ form.title.errors }}
    </div>
    <div class="form-group">
      <label for="id_description">Description</label>
      {{ form.description }}
      {{ form.description.errors }}
    </div>
  </section>

  {% if not has_locations %}
  <div class="form-errors" role="alert">
    <strong>Add a location first.</strong> <a href="{% url 'lora_admin:locations' %}">Go to Locations</a> to create one before adding properties.
  </div>
  {% endif %}
  <section class="form-section">
    <h3>3. Price & Location</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="id_price">Price</label>
        {{ form.price }}
        {{ form.price.errors }}
      </div>
      <div class="form-group">
        <label for="id_currency">Currency</label>
        {{ form.currency }}
      </div>
    </div>
    <div class="form-group">
      <label for="id_location">Location</label>
      {{ form.location }}
      {{ form.location.errors }}
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="id_contact_phone">Phone Number</label>
        {{ form.contact_phone }}
      </div>
      <div class="form-group">
        <label for="id_contact_whatsapp">WhatsApp Number</label>
        {{ form.contact_whatsapp }}
      </div>
    </div>
  </section>

  <section class="form-section">
    <h3>4. Property Details</h3>
    <div class="form-row form-row-3">
      <div class="form-group">
        <label for="id_bedrooms">Bedrooms</label>
        {{ form.bedrooms }}
      </div>
      <div class="form-group">
        <label for="id_bathrooms">Bathrooms</label>
        {{ form.bathrooms }}
      </div>
      <div class="form-group">
        <label for="id_area_size">Area Size (m²)</label>
        {{ form.area_size }}
      </div>
    </div>
    <div class="form-row">
      <div class="form-group form-check">
        <label>{{ form.featured }} Featured</label>
      </div>
      <div class="form-group form-check">
        <label>{{ form.published }} Publish <span class="form-hint-inline">(shows on website)</span></label>
      </div>
    </div>
  </section>

  <section class="property-images-card">
    <div class="property-images-header">
      <h3>5. Property Images</h3>
      <div class="property-images-header-actions">
        <label for="id_gallery_file_input" class="btn btn-add-image" title="Add one or more images">
          <input type="file" id="id_gallery_file_input" accept="image/*" multiple style="display:none">
          + Add Image(s)
        </label>
      </div>
    </div>
    <div class="property-images-table-wrap">
      <table class="property-images-table" id="property-images-table">
        <thead>
          <tr>
            <th class="col-preview">Preview</th>
            <th class="col-caption">Caption</th>
            <th class="col-order">Order</th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if property %}
            {% if property.main_image %}
            <tr class="image-row" data-type="main" data-id="main">
              <td><div class="img-thumb"><img src="{{ property.main_image }}" alt=""></div></td>
              <td class="col-caption-cell"><input type="hidden" name="gallery_visible_main" value="on">—</td>
              <td><input type="number" name="gallery_order_main" value="0" class="image-order-input" min="0" title="Slider position"></td>
              <td><div class="image-actions-inline"><button type="button" class="btn btn-delete-img del-btn">Delete</button></div></td>
            </tr>
            {% endif %}
            {% for img in property.gallery_images.all %}
            <tr class="image-row" data-type="gallery" data-id="{{ img.id }}">
              <td><div class="img-thumb"><img src="{{ img.url }}" alt=""></div></td>
              <td class="col-caption-cell"><input type="hidden" name="gallery_visible_{{ img.id }}" value="{% if img.visible %}on{% endif %}">—</td>
              <td><input type="number" name="gallery_order_{{ img.id }}" value="{{ img.sort_order }}" class="image-order-input" min="0"></td>
              <td><div class="image-actions-inline"><button type="button" class="btn btn-delete-img del-btn">Delete</button></div></td>
            </tr>
            {% endfor %}
          {% endif %}
          <tr class="empty-row" id="images-empty-row" {% if property and property.main_image or property and property.gallery_images.all %}style="display:none"{% endif %}>
            <td colspan="4" class="empty-cell">No images yet. Click &quot;+ Add Image(s)&quot; to add.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="form-section property-video-section">
    <h3>6. Property Video</h3>
    <div class="video-upload-card">
      <label for="id_video_upload" class="form-group">Upload or replace video</label>
      <input type="file" name="video_upload" id="id_video_upload" accept="video/mp4" class="form-input">
      {% if property and property.video_url %}
      <div class="video-preview-card">
        <p class="video-label">Current video</p>
        <video src="{{ property.video_url }}" controls class="preview-video"></video>
      </div>
      {% endif %}
    </div>
  </section>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary btn-lg">Save Property</button>
  </div>
</form>

<script>
(function() {
  var form = document.querySelector('form.property-form');
  var table = document.getElementById('property-images-table');
  var tbody = table && table.querySelector('tbody');
  var emptyRow = document.getElementById('images-empty-row');
  var galleryInput = document.getElementById('id_gallery_file_input');

  if (!tbody) return;

  var deleteIds = [];
  var mainImageDeleted = false;

  function getDisplayRows() {
    return tbody.querySelectorAll('tr.image-row');
  }

  function toggleUI() {
    if (emptyRow) emptyRow.style.display = getDisplayRows().length ? 'none' : 'table-row';
  }

  function addDisplayRowFromFile(src, fileInput, isMain) {
    var tr = document.createElement('tr');
    tr.className = 'image-row';
    tr.dataset.type = isMain ? 'main' : 'gallery';
    tr.dataset.id = isMain ? 'main' : 'new-' + Date.now();
    var captionCell = isMain
      ? '<input type="hidden" name="gallery_visible_main" value="on">—'
      : '—';
    tr.innerHTML = '<td><div class="img-thumb"><img src="'+src.replace(/"/g,'&quot;')+'" alt=""></div></td>' +
      '<td class="col-caption-cell">'+captionCell+'</td>' +
      '<td><input type="number" class="image-order-input" name="'+(isMain?'gallery_order_main':'')+'" min="0" value="0"></td>' +
      '<td><div class="image-actions-inline"><button type="button" class="btn btn-delete-img del-btn">Delete</button></div></td>';
    fileInput.name = isMain ? 'main_image_upload' : 'gallery_uploads';
    fileInput.style.cssText = 'position:absolute;clip:rect(0,0,0,0);width:1px;height:1px;margin:-1px;overflow:hidden;';
    tr.querySelector('.image-actions-inline').appendChild(fileInput);
    emptyRow.insertAdjacentElement('beforebegin', tr);
    bindRowActions(tr);
    updateOrderNumbers();
    toggleUI();
  }

  function bindRowActions(tr) {
    var delBtn = tr.querySelector('.del-btn');
    var id = tr.dataset.id;
    var type = tr.dataset.type;
    if (delBtn) {
      delBtn.addEventListener('click', function() {
        if (type === 'main') mainImageDeleted = true;
        else if (id && id !== 'main' && !String(id).startsWith('new-')) deleteIds.push(id);
        tr.remove();
        toggleUI();
      });
    }
  }

  tbody.querySelectorAll('tr.image-row').forEach(bindRowActions);

  function updateOrderNumbers() {
    var rows = getDisplayRows();
    rows.forEach(function(r, i) {
      var inp = r.querySelector('.image-order-input');
      if (inp && inp.name !== 'gallery_order_main' && !String(inp.name || '').startsWith('gallery_order_')) {
        inp.value = i;
      }
    });
  }

  if (galleryInput) {
    galleryInput.addEventListener('change', function(e) {
      var files = e.target.files;
      if (!files || !files.length) return;
      var rows = getDisplayRows();
      var hasMain = false;
      rows.forEach(function(r) { if (r.dataset.type === 'main') hasMain = true; });
      for (var i = 0; i < files.length; i++) {
        (function(file, index) {
          var fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.style.cssText = 'position:absolute;clip:rect(0,0,0,0);width:1px;height:1px;margin:-1px;overflow:hidden;';
          var dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          var reader = new FileReader();
          reader.onload = function() {
            var isMain = !hasMain && index === 0;
            if (isMain) hasMain = true;
            addDisplayRowFromFile(reader.result, fileInput, isMain);
          };
          reader.readAsDataURL(file);
        })(files[i], i);
      }
      e.target.value = '';
    });
  }

  form.addEventListener('submit', function() {
    var rows = Array.from(getDisplayRows());
    rows.forEach(function(row, i) {
      var inp = row.querySelector('input[type="file"]');
      var orderInp = row.querySelector('.image-order-input');
      if (orderInp && orderInp.name !== 'gallery_order_main' && !String(orderInp.name || '').startsWith('gallery_order_')) {
        orderInp.name = 'gallery_order_new_' + i;
      }
      if (inp && !inp.name) inp.name = row.dataset.type === 'main' ? 'main_image_upload' : 'gallery_uploads';
    });
    if (mainImageDeleted) {
      var hi = document.createElement('input');
      hi.type = 'hidden';
      hi.name = 'main_image_delete';
      hi.value = '1';
      form.appendChild(hi);
    }
    if (deleteIds.length) {
      var delInput = document.createElement('input');
      delInput.type = 'hidden';
      delInput.name = 'gallery_delete_ids';
      delInput.value = deleteIds.join(',');
      form.appendChild(delInput);
    }
  });

  toggleUI();
})();
</script>
{% endblock %}
