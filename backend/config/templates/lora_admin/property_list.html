{% extends "lora_admin/base.html" %}

{% block content %}
<div class="page-header">
  <h1>{% if location_filter %}Properties in {{ location_filter.name }}, {{ location_filter.city }}{% else %}Properties{% endif %}</h1>
  <div class="page-actions">
    {% if location_filter %}
    <a href="{% url 'lora_admin:locations' %}" class="btn btn-sm btn-outline">← Locations</a>
    {% endif %}
    <a href="{% url 'lora_admin:property_list' %}{% if location_filter %}?location={{ location_filter.pk }}{% endif %}" class="btn btn-sm{% if not request.GET.type %} active{% endif %}">All</a>
    <a href="{% url 'lora_admin:property_list' %}?type=rent{% if location_filter %}&location={{ location_filter.pk }}{% endif %}" class="btn btn-sm{% if request.GET.type == 'rent' %} active{% endif %}">Rent</a>
    <a href="{% url 'lora_admin:property_list' %}?type=sale{% if location_filter %}&location={{ location_filter.pk }}{% endif %}" class="btn btn-sm{% if request.GET.type == 'sale' %} active{% endif %}">Buy</a>
    <a href="{% url 'lora_admin:property_add' %}" class="btn btn-primary">+ Add Property</a>
  </div>
</div>

<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Type</th>
        <th>Price</th>
        <th>Location</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in properties %}
      <tr>
        <td>{{ p.title }}</td>
        <td>{{ p.get_listing_type_display }}</td>
        <td>{{ p.currency }} {{ p.price|floatformat:0 }}</td>
        <td>{{ p.location.name }}, {{ p.location.city }}</td>
        <td class="status-cell">
          <div class="status-badges">
            {% if p.featured %}<span class="badge badge-featured">Featured</span>{% endif %}
            {% if p.published %}<span class="badge badge-published">Published</span>{% else %}<span class="badge badge-draft">Draft</span>{% endif %}
            {% if p.availability == 'occupied' or p.availability == 'booked' %}<span class="badge badge-occupied">Occupied</span>{% else %}<span class="badge badge-available">Available</span>{% endif %}
          </div>
          <div class="dropdown-wrap status-dropdown">
            <button type="button" class="btn-status-toggle" aria-label="Change status">▼</button>
            <div class="dropdown-menu">
              <form method="post" action="{% url 'lora_admin:property_toggle_status' p.pk %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="status-menu-form">
                {% csrf_token %}
                <input type="hidden" name="field" value="featured">
                <button type="submit" class="dropdown-item-btn">
                  Featured{% if p.featured %} ✓{% endif %}
                </button>
              </form>
              <form method="post" action="{% url 'lora_admin:property_toggle_status' p.pk %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="status-menu-form">
                {% csrf_token %}
                <input type="hidden" name="field" value="published">
                <button type="submit" class="dropdown-item-btn">
                  Publish{% if p.published %} ✓{% endif %}
                </button>
              </form>
              <form method="post" action="{% url 'lora_admin:property_toggle_status' p.pk %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="status-menu-form">
                {% csrf_token %}
                <input type="hidden" name="field" value="available">
                <button type="submit" class="dropdown-item-btn">
                  Available{% if p.availability == 'available' %} ✓{% endif %}
                </button>
              </form>
              <form method="post" action="{% url 'lora_admin:property_toggle_status' p.pk %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="status-menu-form">
                {% csrf_token %}
                <input type="hidden" name="field" value="occupied">
                <button type="submit" class="dropdown-item-btn">
                  Occupied{% if p.availability == 'occupied' or p.availability == 'booked' %} ✓{% endif %}
                </button>
              </form>
            </div>
          </div>
        </td>
        <td>
          <div class="dropdown-wrap">
            <button type="button" class="btn-dots-minimal" aria-label="Actions">&#8942;</button>
            <div class="dropdown-menu">
              <a href="{% url 'lora_admin:property_edit' p.pk %}">Edit</a>
              <a href="{% url 'lora_admin:property_delete' p.pk %}">Delete</a>
            </div>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="empty-cell">No properties. <a href="{% url 'lora_admin:property_add' %}">Add one</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
