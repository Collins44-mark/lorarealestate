<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Property details - Lora Real Estate">
  <title>Property Details | Lora Real Estate</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner container">
      <a href="index.html" class="logo logo-link">
        <span class="logo-container">
          <img src="images/logo.png" alt="Lora Real Estate" class="logo-img" onerror="this.parentElement.style.display='none'">
        </span>
        <span class="logo-text">Lora <span>Real Estate</span></span>
      </a>
      <button class="nav-toggle" aria-label="Toggle menu">☰</button>
      <nav class="nav-menu">
        <a href="index.html">Home</a>
        <a href="buy.html">Buy</a>
        <a href="rent.html">Rent</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <!-- Property Detail - Content loaded by JS -->
  <main id="propertyDetail">
    <div class="empty-state">
      <p>Loading property details...</p>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-brand">
          <a href="index.html" class="footer-logo">
            <span class="footer-logo-container">
              <img src="images/logo.png" alt="Lora Real Estate" class="footer-logo-img" onerror="this.parentElement.style.display='none'">
            </span>
            <span>Lora Real Estate</span>
          </a>
          <p class="footer-tagline">Your trusted partner for buying and renting properties.</p>
        </div>
        <div class="footer-quick-links">
          <h4>Quick Links</h4>
          <p><a href="buy.html">Buy</a></p>
          <p><a href="rent.html">Rent</a></p>
          <p><a href="about.html">About</a></p>
          <p><a href="contact.html">Contact</a></p>
        </div>
        <div class="footer-contact-icons">
          <h4>Contact</h4>
          <div class="footer-icons">
            <a href="tel:+255788275367" aria-label="Call"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></a>
            <a href="https://wa.me/255788275367" target="_blank" aria-label="WhatsApp"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></a>
            <a href="https://www.instagram.com/lora.realestate?igsh=c2did2pwMWJpaXhx" target="_blank" aria-label="Instagram"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg></a>
            <a href="mailto:info@lorarealestate.com" aria-label="Email"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        &copy; Lora Real Estate. All rights reserved.
      </div>
    </div>
  </footer>

  <!-- WhatsApp Float -->
  <div class="whatsapp-float">
    <a href="https://wa.me/255788275367?text=Hello%2C%20I%20would%20like%20to%20inquire%20about%20properties%20from%20Lora%20Real%20Estate." target="_blank" aria-label="Chat on WhatsApp">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
      </svg>
    </a>
  </div>

  <script src="js/script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const idFromQuery = (params.get('id') || '').trim();
      const idFromHash = (window.location.hash || '').replace(/^#/, '').trim();
      const id = idFromQuery || idFromHash;
      const container = document.getElementById('propertyDetail');
      // Content is loaded from the backend API (no hardcoded data).

      if (!id) {
        container.innerHTML = `
          <div class="section">
            <div class="container">
              <div class="empty-state">
                <h3>Property not found</h3>
                <p>Please go back and select a property from our listings.</p>
                <a href="index.html" class="btn btn-primary" style="margin-top: 1rem;">Back to Home</a>
              </div>
            </div>
          </div>
        `;
        return;
      }

      function getVideoHtml(videoUrl) {
        if (!videoUrl) return '';
        const u = videoUrl.trim();
        let embedSrc = '';
        if (u.includes('youtube.com/watch?v=')) embedSrc = 'https://www.youtube.com/embed/' + u.split('v=')[1].split('&')[0];
        else if (u.includes('youtu.be/')) embedSrc = 'https://www.youtube.com/embed/' + u.split('youtu.be/')[1].split('?')[0];
        if (embedSrc) {
          return `<div class="property-video">
            <h2>Property Video</h2>
            <div class="property-video-wrapper">
              <iframe src="${embedSrc}" title="Property video" allowfullscreen></iframe>
            </div>
          </div>`;
        }
        return `<div class="property-video">
          <h2>Property Video</h2>
          <div class="property-video-wrapper">
            <video src="${u}" controls playsinline></video>
          </div>
        </div>`;
      }

      (async () => {
        try {
          const property = await apiGet(`/api/properties/${encodeURIComponent(id)}/`);

          const currency = property.currency || 'TZS';
          const priceText = property.listing_type === 'sale'
            ? formatPrice(property.price, currency)
            : formatPrice(property.price, currency) + '/month';
          const badgeClass = property.listing_type === 'sale' ? 'badge-sale' : 'badge-rent';
          const badgeText = property.listing_type === 'sale' ? 'For Sale' : 'For Rent';
          const locationText = property.location ? [property.location.name, property.location.city].filter(Boolean).join(', ') : '';

          const isOccupied = property.availability === 'occupied' || property.availability === 'booked';
          const contactPhone = property.contact_phone || '+255788275367';
          const callUrl = `tel:${String(contactPhone).replace(/\\s+/g, '')}`;

          const main = property.main_image ? [{ url: property.main_image, label: 'Main' }] : [];
          const gallery = Array.isArray(property.gallery_images) ? property.gallery_images : [];
          const images = [...main, ...gallery].filter(i => i && i.url);

          const imageGallery = images.map((img, i) => `
            <div class="property-gallery-slide ${i === 0 ? 'active' : ''}" data-index="${i}">
              <img src="${img.url}" alt="${property.title} - ${img.label || 'Image ' + (i+1)}">
            </div>
          `).join('');

          const thumbnails = images.length > 1 ? images.map((img, i) => `
            <button type="button" class="property-gallery-thumb ${i === 0 ? 'active' : ''}" data-index="${i}" aria-label="View image ${i + 1}">
              <img src="${img.url}" alt="">
            </button>
          `).join('') : '';

          const allImagesGrid = images.map((img, i) => `
            <div class="property-image-item">
              <img src="${img.url}" alt="${property.title} - ${img.label || 'Image ' + (i+1)}">
              ${img.label ? `<span class="property-image-label">${img.label}</span>` : ''}
            </div>
          `).join('');

          const videoHtml = getVideoHtml(property.video_url);

          const hasVal = (v) => v != null && v !== '';
          const featureListParts = [];
          if (hasVal(property.bedrooms)) featureListParts.push(`<span><strong>${property.bedrooms}</strong> Bedrooms</span>`);
          if (hasVal(property.bathrooms)) featureListParts.push(`<span><strong>${property.bathrooms}</strong> Bathrooms</span>`);
          if (hasVal(property.area_size)) featureListParts.push(`<span><strong>${property.area_size} m²</strong> Size</span>`);
          const featureListHtml = featureListParts.length
            ? `<div class="property-features-list">${featureListParts.join('')}</div>`
            : '';

          const detailRows = [
            '<div class="detail-item"><strong>Property ID</strong><span>#' + property.id + '</span></div>',
            '<div class="detail-item"><strong>Price</strong><span>' + priceText + '</span></div>'
          ];
          if (locationText) detailRows.push('<div class="detail-item"><strong>Location</strong><span>' + locationText + '</span></div>');
          if (hasVal(property.area_size)) detailRows.push('<div class="detail-item"><strong>Size</strong><span>' + property.area_size + ' m²</span></div>');
          if (hasVal(property.bedrooms)) detailRows.push('<div class="detail-item"><strong>Bedrooms</strong><span>' + property.bedrooms + '</span></div>');
          if (hasVal(property.bathrooms)) detailRows.push('<div class="detail-item"><strong>Bathrooms</strong><span>' + property.bathrooms + '</span></div>');
          detailRows.push('<div class="detail-item"><strong>Availability</strong><span>' + (isOccupied ? 'Occupied' : 'Available') + '</span></div>');

          container.innerHTML = `
            <div class="property-gallery">
              <div class="property-gallery-main">
                ${imageGallery || '<div class="empty-state"><p>No images available.</p></div>'}
                ${images.length > 1 ? `
                  <button type="button" class="gallery-nav gallery-prev" aria-label="Previous image">&lsaquo;</button>
                  <button type="button" class="gallery-nav gallery-next" aria-label="Next image">&rsaquo;</button>
                ` : ''}
              </div>
              ${images.length > 1 ? `<div class="property-gallery-thumbs">${thumbnails}</div>` : ''}
            </div>
            <div class="property-detail-content">
              <div class="property-detail-header">
                <div class="property-detail-title">
                  <span class="property-badge ${badgeClass}">${badgeText}</span>
                  ${isOccupied ? '<span class="property-badge badge-occupied">Occupied</span>' : ''}
                  <h1 style="margin-top: 1rem;">${property.title}</h1>
                  <div class="property-price" style="margin: 0.5rem 0;">${priceText}</div>
                  <div class="property-location-detail">
                    <svg class="icon-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                      <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    ${locationText}
                  </div>
                </div>
              </div>
              ${featureListHtml}
              ${videoHtml}
              <div class="property-description">
                <h2>Full Description</h2>
                <p class="property-description-text">${property.description}</p>
              </div>
              <div class="property-details-summary">
                <h2>Property Details</h2>
                <div class="details-grid">
                  ${detailRows.join('')}
                </div>
              </div>
              <div class="property-all-images">
                <h2>All Images</h2>
                <div class="property-images-grid">${allImagesGrid}</div>
              </div>
              <div class="property-book-visit">
                ${isOccupied
                  ? '<p class="property-occupied-msg">This property is currently occupied and not available for viewing at this time.</p>'
                  : `<a href="${callUrl}" class="btn btn-secondary btn-lg">Call Agent</a>
                <button type="button" class="btn btn-primary btn-lg" id="bookVisitBtn">Book a Visit</button>`
                }
              </div>
            </div>
          `;

          if (images.length > 1) {
            const slides = container.querySelectorAll('.property-gallery-slide');
            const thumbs = container.querySelectorAll('.property-gallery-thumb');
            const prevBtn = container.querySelector('.gallery-prev');
            const nextBtn = container.querySelector('.gallery-next');
            let current = 0;

            function showSlide(i) {
              current = (i + images.length) % images.length;
              slides.forEach((s, idx) => s.classList.toggle('active', idx === current));
              thumbs.forEach((t, idx) => t.classList.toggle('active', idx === current));
            }
            prevBtn?.addEventListener('click', () => showSlide(current - 1));
            nextBtn?.addEventListener('click', () => showSlide(current + 1));
            thumbs.forEach((t, i) => t.addEventListener('click', () => showSlide(i)));
          }

          const bookVisitBtn = container.querySelector('#bookVisitBtn');
          if (bookVisitBtn) {
            const modalHtml = `
              <div class="modal-overlay" id="bookVisitModal" aria-hidden="true">
                <div class="modal-content modal-book-visit">
                  <div class="modal-top">
                    <h3 class="modal-title">Schedule a Property Viewing</h3>
                    <button type="button" class="modal-close" aria-label="Close">&times;</button>
                  </div>
                  <p class="modal-subtitle">Request a viewing for this property. Our team will contact you to confirm.</p>
                  <form id="bookVisitForm" class="book-visit-form">
                    <input type="hidden" name="propertyId" value="${property.id}">
                    <div class="form-row form-row-2">
                      <div class="form-group">
                        <label for="visitName">Full Name <span class="required">*</span></label>
                        <input type="text" id="visitName" name="full_name" required placeholder="Your full name">
                      </div>
                      <div class="form-group">
                        <label for="visitEmail">Email <span class="required">*</span></label>
                        <input type="email" id="visitEmail" name="email" required placeholder="Your email">
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="visitPhone">Phone Number <span class="form-hint">(We'll call or WhatsApp to confirm)</span></label>
                      <input type="tel" id="visitPhone" name="phone" placeholder="Your phone number">
                    </div>
                    <div class="form-row form-row-2 form-row-date-time">
                      <div class="form-group">
                        <label for="visitDate">Preferred Date <span class="required">*</span></label>
                        <input type="date" id="visitDate" name="preferred_date" required>
                      </div>
                      <div class="form-group">
                        <label for="visitTime">Preferred Time <span class="required">*</span></label>
                        <input type="time" id="visitTime" name="preferred_time" required>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="visitMessage">Additional Notes</label>
                      <textarea id="visitMessage" name="message" rows="3" placeholder="Any special requests or questions..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Request a visit</button>
                  </form>
                </div>
              </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = document.getElementById('bookVisitModal');
            const form = document.getElementById('bookVisitForm');

            bookVisitBtn.addEventListener('click', () => {
              modal.classList.add('open');
              modal.setAttribute('aria-hidden', 'false');
              document.body.style.overflow = 'hidden';
            });

            const closeModal = () => {
              modal.classList.remove('open');
              modal.setAttribute('aria-hidden', 'true');
              document.body.style.overflow = '';
            };

            modal.querySelector('.modal-close').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

            form.addEventListener('submit', async (e) => {
              e.preventDefault();
              const payload = {
                property: Number(form.propertyId.value),
                full_name: form.querySelector('[name="full_name"]').value.trim(),
                email: form.querySelector('[name="email"]').value.trim(),
                phone: form.querySelector('[name="phone"]').value.trim(),
                preferred_date: form.querySelector('[name="preferred_date"]').value,
                preferred_time: form.querySelector('[name="preferred_time"]').value,
                message: form.querySelector('[name="message"]').value.trim()
              };
              try {
                await apiPost('/api/bookings/', payload);
                alert('Thank you! Your viewing request has been submitted. We will contact you shortly to confirm.');
                form.reset();
                closeModal();
              } catch (err) {
                alert('Unable to submit your request. Please try again or contact us directly.');
                console.error(err);
              }
            });
          }
        } catch (e) {
          container.innerHTML = `
            <div class="section">
              <div class="container">
                <div class="empty-state">
                  <h3>Property not found</h3>
                  <p>This property may no longer be available. Browse our current listings.</p>
                  <a href="buy.html" class="btn btn-primary" style="margin-top: 1rem;">View Properties for Sale</a>
                  <a href="rent.html" class="btn btn-secondary" style="margin-top: 1rem; margin-left: 0.5rem;">View Rentals</a>
                </div>
              </div>
            </div>
          `;
          console.error(e);
        }
      })();
    });
  </script>
</body>
</html>
